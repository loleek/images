# å®Œæ•´ç‰ˆ LaTeX æ‰¹é‡è½¬æ¢å™¨ - åŒ…å«æ‰€æœ‰å­—ä½“å’Œä¸­æ–‡æ”¯æŒ
# ä½¿ç”¨å›½å†…é•œåƒæºçš„ Ubuntu 22.04 ä»¥åŠ é€Ÿä¸‹è½½
FROM registry.cn-hangzhou.aliyuncs.com/acs/ubuntu:22.04

# è®¾ç½®ç¯å¢ƒå˜é‡é¿å…äº¤äº’å¼å®‰è£…
ENV DEBIAN_FRONTEND=noninteractive

# æ›´æ¢ä¸ºå›½å†…è½¯ä»¶æºä»¥åŠ é€Ÿå®‰è£…
RUN sed -i 's/archive.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list && \
    sed -i 's/security.ubuntu.com/mirrors.aliyun.com/g' /etc/apt/sources.list

# ==================== ç¬¬ä¸€é˜¶æ®µï¼šå®‰è£…åŸºç¡€ LaTeX ç¯å¢ƒå’Œå·¥å…· ====================
RUN ls -al /etc/apt/apt.conf.d/
RUN rm -f /etc/apt/apt.conf.d/docker-clean
RUN apt-get update && apt-get install -y \
    # åŸºç¡€ LaTeX åŒ…
    texlive-latex-base \
    texlive-latex-recommended \
    texlive-latex-extra \
    texlive-fonts-recommended \
    texlive-fonts-extra \
    texlive-science \
    texlive-font-utils \
    texlive-plain-generic \
    # XeLaTeX å’Œ LuaLaTeX æ”¯æŒ
    texlive-xetex \
    texlive-luatex \
    # ä¸­æ–‡ LaTeX æ”¯æŒ
    texlive-lang-chinese \
    latex-cjk-chinese \
    latex-cjk-chinese-arphic-bkai00mp \
    latex-cjk-chinese-arphic-bsmi00lp \
    latex-cjk-chinese-arphic-gbsn00lp \
    latex-cjk-chinese-arphic-gkai00mp \
    # å›¾ç‰‡è½¬æ¢å·¥å…·
    imagemagick \
    ghostscript \
    poppler-utils \
    # ä¸‹è½½å’Œå­—ä½“å·¥å…·
    wget \
    curl \
    unzip \
    git \
    fontconfig

# é…ç½® ImageMagick å®‰å…¨ç­–ç•¥ï¼Œå…è®¸å¤„ç† PDF
RUN sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/g' /etc/ImageMagick-6/policy.xml

# ==================== ç¬¬äºŒé˜¶æ®µï¼šå®‰è£…ä¸­æ–‡å­—ä½“ ====================
RUN apt-get update && apt-get install -y \
    # åŸºç¡€ä¸­æ–‡å­—ä½“
    fonts-noto-cjk \
    fonts-noto-cjk-extra \
    fonts-noto-extra \
    fonts-wqy-microhei \
    fonts-wqy-zenhei \
    fonts-arphic-ukai \
    fonts-arphic-uming \
    fonts-arphic-bkai00mp \
    fonts-arphic-gkai00mp

# ==================== ç¬¬ä¸‰é˜¶æ®µï¼šåˆ›å»ºå­—ä½“ç›®å½•ç»“æ„ ====================
RUN mkdir -p /usr/share/fonts/truetype/custom
RUN mkdir -p /usr/share/fonts/truetype/google-fonts
RUN mkdir -p /usr/share/fonts/truetype/handwriting
RUN mkdir -p /usr/share/fonts/truetype/chinese-handwriting
RUN mkdir -p /usr/share/fonts/truetype/zcool
RUN mkdir -p /usr/share/fonts/truetype/alibaba
RUN mkdir -p /usr/share/fonts/truetype/creative
RUN mkdir -p /usr/share/fonts/truetype/enhanced

# è®¾ç½®ä¸´æ—¶å·¥ä½œç›®å½•
WORKDIR /tmp/fonts

# ==================== ç¬¬å››é˜¶æ®µï¼šä¸‹è½½ Google Fonts æ‰‹å†™ä½“å­—ä½“ ====================
RUN echo "ä¸‹è½½ Google Fonts æ‰‹å†™ä½“å­—ä½“..." && \
    cd /usr/share/fonts/truetype/google-fonts && \
    # Patrick Hand - æ‰‹å†™ä½“
    (wget -O PatrickHand-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/patrickhand/PatrickHand-Regular.ttf" || echo "Patrick Hand ä¸‹è½½å¤±è´¥") && \
    # Homemade Apple - æ‰‹å·¥é£æ ¼
    (wget -O HomemadeApple-Regular.ttf "https://github.com/google/fonts/raw/main/apache/homemadeapple/HomemadeApple-Regular.ttf" || echo "Homemade Apple ä¸‹è½½å¤±è´¥") && \
    # Dancing Script - èˆåŠ¨æ‰‹å†™ä½“
    (wget -O DancingScript-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/dancingscript/DancingScript%5Bwght%5D.ttf" || echo "Dancing Script ä¸‹è½½å¤±è´¥") && \
    # Shadows Into Light - é˜´å½±ä½“ (ä¿®å¤URL)
    (wget -O ShadowsIntoLight-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/shadowsintolight/ShadowsIntoLight-Regular.ttf" || \
     wget -O ShadowsIntoLight-Regular.ttf "https://fonts.gstatic.com/s/shadowsintolight/v19/UqyNK9UOIntux_czAvDQx_ZcHqZXBNQDcsr4xzSMYA.ttf" || \
     echo "Shadows Into Light ä¸‹è½½å¤±è´¥") && \
    # Amatic SC - æ‰‹ç»˜é£æ ¼ (ä¿®å¤URL)
    (wget -O AmaticSC-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/amaticsc/AmaticSC-Regular.ttf" || \
     wget -O AmaticSC-Regular.ttf "https://fonts.gstatic.com/s/amaticsc/v26/TUZyzwprpvBS1izr_vOMscDJvBs.ttf" || \
     echo "Amatic SC Regular ä¸‹è½½å¤±è´¥") && \
    (wget -O AmaticSC-Bold.ttf "https://github.com/google/fonts/raw/main/ofl/amaticsc/AmaticSC-Bold.ttf" || \
     wget -O AmaticSC-Bold.ttf "https://fonts.gstatic.com/s/amaticsc/v26/TUZ3zwprpvBS1izr_vO0De6ecZQf-A.ttf" || \
     echo "Amatic SC Bold ä¸‹è½½å¤±è´¥") && \
    # Handlee - è‡ªç„¶æ‰‹å†™ä½“
    (wget -O Handlee-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/handlee/Handlee-Regular.ttf" || echo "Handlee ä¸‹è½½å¤±è´¥") && \
    # Kalam - ç°ä»£æ‰‹å†™ä½“
    (wget -O Kalam-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/kalam/Kalam-Regular.ttf" || echo "Kalam ä¸‹è½½å¤±è´¥") && \
    # Caveat - éšæ„é£æ ¼
    (wget -O Caveat-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/caveat/Caveat%5Bwght%5D.ttf" || echo "Caveat ä¸‹è½½å¤±è´¥") && \
    # Architects Daughter - å»ºç­‘å¸ˆå¥³å„¿ä½“
    (wget -O ArchitectsDaughter-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/architectsdaughter/ArchitectsDaughter-Regular.ttf" || echo "Architects Daughter ä¸‹è½½å¤±è´¥") && \
    # Indie Flower - ç‹¬ç«‹èŠ±ä½“
    (wget -O IndieFlower-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/indieflower/IndieFlower-Regular.ttf" || echo "Indie Flower ä¸‹è½½å¤±è´¥") && \
    # Nothing You Could Do - éšæ€§ä½“
    (wget -O NothingYouCouldDo-Regular.ttf "https://github.com/google/fonts/raw/main/ofl/nothingyoucoulddo/NothingYouCouldDo-Regular.ttf" || echo "Nothing You Could Do ä¸‹è½½å¤±è´¥") && \
    echo "Google Fonts å­—ä½“ä¸‹è½½å®Œæˆ"

# ==================== ç¬¬äº”é˜¶æ®µï¼šä¸‹è½½ç«™é…·å­—ä½“ç³»åˆ— ====================
RUN echo "ä¸‹è½½ç«™é…·å­—ä½“ç³»åˆ—..." && \
    cd /usr/share/fonts/truetype/zcool && \
    # ç«™é…·å¿«ä¹ä½“
    wget -O ZcoolKuaiLe-Regular.ttf "https://fonts.gstatic.com/s/zcoolkuaile/v11/tssQApxBaigK_hnnc1qPcEU3dSuLDU-4Gb1s.ttf" && \
    # ç«™é…·å°å¾®ä½“
    wget -O ZcoolXiaoWei-Regular.ttf "https://fonts.gstatic.com/s/zcoolxiaowei/v10/i7dMIFByZjaNAMxtZcnfAy5H2S6S7gTtJLfE.ttf" && \
    # å°è¯•ä¸‹è½½ç«™é…·é’ç§‘é»„æ²¹ä½“
    git clone --depth 1 https://github.com/googlefonts/zcool-qingke-huangyou.git qingke 2>/dev/null && \
    if [ -d qingke ]; then \
        find qingke -name "*.ttf" -o -name "*.otf" | xargs -I {} cp {} .; \
        rm -rf qingke; \
    fi || echo "ç«™é…·é’ç§‘é»„æ²¹ä½“ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"

# ==================== ç¬¬å…­é˜¶æ®µï¼šä¸‹è½½é˜¿é‡Œå·´å·´æ™®æƒ ä½“ ====================
RUN echo "ä¸‹è½½é˜¿é‡Œå·´å·´æ™®æƒ ä½“..." && \
    cd /usr/share/fonts/truetype/alibaba && \
    # ä»é˜¿é‡Œå·´å·´å®˜æ–¹æºä¸‹è½½
    wget -O AlibabaSans.zip "https://puhuiti.oss-cn-hangzhou.aliyuncs.com/AlibabaSans.zip" && \
    if [ -f AlibabaSans.zip ]; then \
        unzip -q AlibabaSans.zip; \
        rm -f AlibabaSans.zip; \
    fi || \
    # å¤‡ç”¨ä¸‹è½½æº
    wget -O AlibabaSans-Regular.ttf "https://github.com/AlibabaPuHuiTi/AlibabaPuHuiTi/releases/download/v3.0.0/AlibabaSans-Regular.ttf" || \
    echo "é˜¿é‡Œå·´å·´æ™®æƒ ä½“ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡"

# ==================== ç¬¬ä¸ƒé˜¶æ®µï¼šä¸‹è½½å¼€æºä¸­æ–‡åˆ›æ„å­—ä½“ ====================
RUN echo "ä¸‹è½½å¼€æºä¸­æ–‡åˆ›æ„å­—ä½“..." && \
    cd /usr/share/fonts/truetype/creative && \
    # å¾—æ„é»‘ï¼ˆç°ä»£åˆ›æ„å­—ä½“ï¼‰
    wget -O SmileySans-Oblique.ttf "https://github.com/atelier-anchor/smiley-sans/releases/download/v2.0.1/SmileySans-Oblique.ttf" && \
    # éœé¹œæ–‡æ¥·ï¼ˆæ‰‹å†™æ¥·ä½“é£æ ¼ï¼‰
    wget -O LXGWWenKai-Regular.ttf "https://github.com/lxgw/LxgwWenKai/releases/download/v1.330/LXGWWenKai-Regular.ttf" && \
    wget -O LXGWWenKai-Bold.ttf "https://github.com/lxgw/LxgwWenKai/releases/download/v1.330/LXGWWenKai-Bold.ttf" && \
    # éœé¹œæ–°æ™°é»‘ï¼ˆç°ä»£é»‘ä½“ï¼‰
    wget -O LXGWNewClear-Regular.ttf "https://github.com/lxgw/LxgwNewClear/releases/download/v1.021/LXGWNewClear-Regular.ttf" || \
    echo "éƒ¨åˆ†åˆ›æ„å­—ä½“ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­"

# ==================== ç¬¬å…«é˜¶æ®µï¼šä¸‹è½½æ›´å¤šæ‰‹å†™é£æ ¼å­—ä½“ ====================
RUN echo "ä¸‹è½½æ›´å¤šæ‰‹å†™é£æ ¼å­—ä½“..." && \
    cd /usr/share/fonts/truetype/handwriting && \
    # æ±Ÿè¥¿æ‹™æ¥·ï¼ˆæ‰‹å†™æ¥·ä½“ï¼‰
    wget -O JiangxiZhuoKai-Regular.ttf "https://github.com/TrionesType/zhuoque/releases/download/v1.002/TrionesZhuoKai-Regular.ttf" && \
    # ä»“è€³ä»Šæ¥·ï¼ˆç°ä»£æ¥·ä½“ï¼‰
    wget -O TsangerJinKai-Regular.ttf "https://github.com/tsanger/Tsanger/releases/download/v2.042/TsangerJinKai03-W03.ttf" && \
    # ä¼˜è®¾æ ‡é¢˜é»‘ï¼ˆåˆ›æ„é»‘ä½“ï¼‰
    wget -O YousheBiaotihei-Regular.ttf "https://github.com/atelier-anchor/smiley-sans/releases/download/v2.0.1/SmileySans-Oblique.ttf" || \
    echo "éƒ¨åˆ†æ‰‹å†™å­—ä½“ä¸‹è½½å¤±è´¥ï¼Œç»§ç»­"

# ==================== ç¬¬ä¹é˜¶æ®µï¼šåˆ›å»ºå­—ä½“å›é€€é“¾æ¥å’Œåˆ«å ====================
RUN echo "åˆ›å»ºå­—ä½“å›é€€æœºåˆ¶å’Œåˆ«å..." && \
    # åˆ›å»ºå­—ä½“åˆ«åé…ç½®æ–‡ä»¶
    mkdir -p /etc/fonts/conf.d
COPY 99-font-aliases.conf /etc/fonts/conf.d/99-font-aliases.conf

# åˆ›å»ºå­—ä½“å›é€€é“¾æ¥
RUN echo "åˆ›å»ºå­—ä½“å›é€€é“¾æ¥..." && \
    # å¦‚æœæŸäº›å­—ä½“ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨å·²æœ‰å­—ä½“ä½œä¸ºå›é€€
    cd /usr/share/fonts/truetype/zcool && \
    if [ ! -f ZcoolKuaiLe-Regular.ttf ] && [ -f /usr/share/fonts/truetype/creative/LXGWWenKai-Regular.ttf ]; then \
        ln -sf /usr/share/fonts/truetype/creative/LXGWWenKai-Regular.ttf ZcoolKuaiLe-Regular.ttf; \
    fi && \
    if [ ! -f ZcoolXiaoWei-Regular.ttf ] && [ -f /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc ]; then \
        ln -sf /usr/share/fonts/opentype/noto/NotoSansCJK-Regular.ttc ZcoolXiaoWei-Regular.ttf; \
    fi && \
    # ä¸ºç¼ºå¤±çš„Google Fontsåˆ›å»ºå›é€€é“¾æ¥
    cd /usr/share/fonts/truetype/google-fonts && \
    if [ ! -f ShadowsIntoLight-Regular.ttf ] && [ -f PatrickHand-Regular.ttf ]; then \
        ln -sf PatrickHand-Regular.ttf ShadowsIntoLight-Regular.ttf; \
    fi && \
    if [ ! -f AmaticSC-Regular.ttf ] && [ -f PatrickHand-Regular.ttf ]; then \
        ln -sf PatrickHand-Regular.ttf AmaticSC-Regular.ttf; \
    fi

# ==================== ç¬¬åé˜¶æ®µï¼šè®¾ç½®å­—ä½“æƒé™å’Œæ›´æ–°ç¼“å­˜ ====================
RUN echo "è®¾ç½®å­—ä½“æƒé™å’Œæ›´æ–°ç¼“å­˜..." && \
    # è®¾ç½®æ‰€æœ‰å­—ä½“æ–‡ä»¶çš„æ­£ç¡®æƒé™
    find /usr/share/fonts/truetype -type f \( -name "*.ttf" -o -name "*.otf" \) -exec chmod 644 {} \; 2>/dev/null || true && \
    # æ›´æ–°å­—ä½“ç¼“å­˜
    fc-cache -fv

# ==================== ç¬¬åä¸€é˜¶æ®µï¼šåˆ›å»ºå·¥ä½œç›®å½•å’Œè„šæœ¬ ====================
WORKDIR /workspace

# å¤åˆ¶è½¬æ¢è„šæœ¬
COPY convert_fixed.sh /usr/local/bin/convert.sh
COPY batch_convert.sh /usr/local/bin/batch_convert.sh
COPY batch_convert_parallel.sh /usr/local/bin/batch_convert_parallel.sh
RUN chmod +x /usr/local/bin/convert.sh /usr/local/bin/batch_convert.sh /usr/local/bin/batch_convert_parallel.sh

# ==================== ç¬¬åäºŒé˜¶æ®µï¼šåˆ›å»ºå­—ä½“ç®¡ç†è„šæœ¬ ====================
COPY list-all-fonts.sh /usr/local/bin/list-all-fonts.sh
RUN chmod +x /usr/local/bin/list-all-fonts.sh

# ==================== ç¬¬åä¸‰é˜¶æ®µï¼šåˆ›å»ºå­—ä½“æµ‹è¯•è„šæœ¬ ====================
COPY test-fonts.sh /usr/local/bin/test-fonts.sh
RUN chmod +x /usr/local/bin/test-fonts.sh

# ==================== ç¬¬åå››é˜¶æ®µï¼šæ¸…ç†å’Œæœ€ç»ˆè®¾ç½® ====================
# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
RUN rm -rf /tmp/fonts

# åˆ›å»ºå­—ä½“æ˜ å°„æ–‡æ¡£
COPY FONT_MAPPING.md /usr/share/fonts/FONT_MAPPING.md

# æ˜¾ç¤ºå®‰è£…å®Œæˆä¿¡æ¯
RUN echo "í ¼ LaTeX å®Œæ•´ç‰ˆæ„å»ºå®Œæˆï¼" && \
    echo "í ½ å®‰è£…çš„å­—ä½“æ€»æ•°: $(fc-list | wc -l)" && \
    echo "í ½ è¿è¡Œ 'list-all-fonts.sh' æŸ¥çœ‹è¯¦ç»†å­—ä½“ä¿¡æ¯" && \
    echo "í ¾ è¿è¡Œ 'test-fonts.sh' æµ‹è¯•å­—ä½“åŠŸèƒ½" && \
    echo "í ½ æŸ¥çœ‹ /usr/share/fonts/FONT_MAPPING.md äº†è§£å­—ä½“æ˜ å°„"

# è®¾ç½®å…¥å£ç‚¹ä¸ºæ‰¹é‡è½¬æ¢è„šæœ¬
ENTRYPOINT ["/usr/local/bin/batch_convert.sh"]
